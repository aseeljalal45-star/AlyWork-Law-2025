import streamlit as st
from helpers.ui_components import section_header

config = st.session_state.get("config", {})
ICON_PATH = config.get("UI", {}).get("ICON_PATH", "assets/icons/")
MAX_CARDS = config.get("RECOMMENDER", {}).get("MAX_CARDS", 6)
CARD_TEXT_COLOR = config.get("RECOMMENDER", {}).get("CARD_TEXT_COLOR", "#FFFFFF")

def get_recommendations_data():
    """ุฅุฑุฌุงุน ุจูุงูุงุช ุงูุชูุตูุงุช ุงูุฐููุฉ ุงูููุธูุฉ ุญุณุจ ุงููุฆุงุช"""
    data = {
        "ุงูุนูุงู": [
            {
                "ุงูุนููุงู": "ุงุญุณุจ ููุงูุฃุฉ ููุงูุฉ ุงูุฎุฏูุฉ", 
                "ุงููุตู": "ุญุณุงุจ ุฏููู ููุณุชุญูุงุช ููุงูุฉ ุงูุฎุฏูุฉ ููู ุงููุงููู ุงูุฃุฑุฏูู", 
                "ุงูููุน": "ุญุงุณุจุฉ", 
                "link": "#calculators", 
                "icon": "๐งฎ",
                "action": "ุงุญุณุจ ุงูุขู"
            },
            {
                "ุงูุนููุงู": "ุฑุงุฌุน ุญูููู ุงูุฃุณุงุณูุฉ", 
                "ุงููุตู": "ุฏููู ุดุงูู ูุญููู ุงูุนูุงู ูู ูุงููู ุงูุนูู ุงูุฃุฑุฏูู", 
                "ุงูููุน": "ุชูุนูุฉ", 
                "link": "#rights", 
                "icon": "๐",
                "action": "ุงุณุชุนุฑุถ ุงูุญููู"
            },
            {
                "ุงูุนููุงู": "ูุญุงูู ุงูุดููู ุงูุฐูู", 
                "ุงููุตู": "ุญูู ุญุงูุชู ูุงุญุตู ุนูู ุชูุตูุงุช ูุงููููุฉ ูุฎุตุตุฉ", 
                "ุงูููุน": "ูุงูููู", 
                "link": "#complaint", 
                "icon": "โ๏ธ",
                "action": "ุงุจุฏุฃ ุงูุชุญููู"
            },
            {
                "ุงูุนููุงู": "ุฏููู ุงูุฌูุงุช ุงููุฎุชุตุฉ", 
                "ุงููุตู": "ุชุนุฑู ุนูู ุฃูุงูู ุชูุฏูู ุงูุดูุงูู ูู ูุญุงูุธุชู", 
                "ุงูููุน": "ูุฑุฌุน", 
                "link": "#authorities", 
                "icon": "๐๏ธ",
                "action": "ุงุณุชูุดุงู"
            },
            {
                "ุงูุนููุงู": "ุญุงุณุจุฉ ุงูุนูู ุงูุฅุถุงูู", 
                "ุงููุตู": "ุงุญุณุจ ูุณุชุญูุงุช ุงูุนูู ุงูุฅุถุงูู ูุงูููุงูู ูุงูุนุทูุงุช", 
                "ุงูููุน": "ุญุงุณุจุฉ", 
                "link": "#overtime", 
                "icon": "โฐ",
                "action": "ุงุญุณุจ ุงููุณุชุญูุงุช"
            },
            {
                "ุงูุนููุงู": "ูููุฐุฌ ุดููู ุฌุงูุฒ", 
                "ุงููุตู": "ููุงุฐุฌ ูุงููููุฉ ูุนุฏุฉ ูุณุจูุงู ูุชูุฏูู ุงูุดูุงูู", 
                "ุงูููุน": "ูููุฐุฌ", 
                "link": "#templates", 
                "icon": "๐",
                "action": "ุงุณุชุฎุฏู ุงููููุฐุฌ"
            }
        ],
        "ุฃุตุญุงุจ ุงูุนูู": [
            {
                "ุงูุนููุงู": "ุญุงุณุจุฉ ุงูุชูุงููู ุงูุดูุฑูุฉ", 
                "ุงููุตู": "ุชูุฏูุฑ ุงูุชุฒุงูุงุช ุงูุฃุฌูุฑ ูุงูุถุฑุงุฆุจ ูุงูุงุดุชุฑุงูุงุช", 
                "ุงูููุน": "ุญุงุณุจุฉ", 
                "link": "#costs", 
                "icon": "๐ฐ",
                "action": "ุงุญุณุจ ุงูุชูุงููู"
            },
            {
                "ุงูุนููุงู": "ุฏููู ุงูุงูุชุฒุงู ุงููุงูููู", 
                "ุงููุตู": "ุงูุชุฒุงูุงุช ุตุงุญุจ ุงูุนูู ููู ุฃุญุฏุซ ุงูุชุนุฏููุงุช", 
                "ุงูููุน": "ุงูุชุซุงู", 
                "link": "#compliance", 
                "icon": "โ",
                "action": "ุฑุงุฌุน ุงูุงูุชุฒุงูุงุช"
            },
            {
                "ุงูุนููุงู": "ููุงุฐุฌ ุนููุฏ ุงูุนูู", 
                "ุงููุตู": "ููุงูุจ ูุงููููุฉ ูุนุฏุฉ ูุนููุฏ ุงูุนูู ุงููุฎุชููุฉ", 
                "ุงูููุน": "ูููุฐุฌ", 
                "link": "#contracts", 
                "icon": "๐",
                "action": "ุงุณุชุนุฑุถ ุงูููุงุฐุฌ"
            },
            {
                "ุงูุนููุงู": "ุญุงุณุจุฉ ุงูุชุนููุถุงุช", 
                "ุงููุตู": "ุชูุฏูุฑ ุงูุชุนููุถุงุช ูู ุญุงูุงุช ุงููุตู ุงููุฎุชููุฉ", 
                "ุงูููุน": "ุญุงุณุจุฉ", 
                "link": "#compensation", 
                "icon": "โ๏ธ",
                "action": "ุงุญุณุจ ุงูุชุนููุถ"
            }
        ],
        "ููุชุดู ุงูุนูู": [
            {
                "ุงูุนููุงู": "ูููุฐุฌ ุชูุฑูุฑ ุชูุชูุด", 
                "ุงููุตู": "ูููุฐุฌ ูุนุชูุฏ ูุชูุงุฑูุฑ ุงูุชูุชูุด ุงูููุฏุงูู", 
                "ุงูููุน": "ูููุฐุฌ", 
                "link": "#inspection", 
                "icon": "๐",
                "action": "ุงุณุชุฎุฏู ุงููููุฐุฌ"
            },
            {
                "ุงูุนููุงู": "ุฏููู ุงูุฅุฌุฑุงุกุงุช", 
                "ุงููุตู": "ุงูุฅุฌุฑุงุกุงุช ุงููุงููููุฉ ููุนุงูุฌุฉ ุงููุฎุงููุงุช", 
                "ุงูููุน": "ูุฑุฌุน", 
                "link": "#procedures", 
                "icon": "๐",
                "action": "ุงุณุชุนุฑุถ ุงูุฏููู"
            },
            {
                "ุงูุนููุงู": "ูุงุนุฏุฉ ุงูุชุดุฑูุนุงุช", 
                "ุงููุตู": "ุฃุญุฏุซ ุงูููุงููู ูุงูููุงุฆุญ ูุงูุชุนูููุงุช", 
                "ุงูููุน": "ูุงูููู", 
                "link": "#regulations", 
                "icon": "โ๏ธ",
                "action": "ุงุจุญุซ ูู ุงูุชุดุฑูุนุงุช"
            }
        ],
        "ุงูุจุงุญุซูู ูุงููุชุฏุฑุจูู": [
            {
                "ุงูุนููุงู": "ููุชุจุฉ ุงูุณูุงุจู ุงููุถุงุฆูุฉ", 
                "ุงููุตู": "ุฃุญูุงู ููุฑุงุฑุงุช ูุญุงูู ุงูุนูู ุงูุณุงุจูุฉ", 
                "ุงูููุน": "ุจุญุซ", 
                "link": "#precedents", 
                "icon": "๐",
                "action": "ุงุณุชุนุฑุถ ุงูุณูุงุจู"
            },
            {
                "ุงูุนููุงู": "ุชุญููู ุงูุงุชุฌุงูุงุช ุงููุงููููุฉ", 
                "ุงููุตู": "ุฏุฑุงุณุงุช ูุชุญูููุงุช ูุชุทูุฑุงุช ูุงููู ุงูุนูู", 
                "ุงูููุน": "ุจุญุซ", 
                "link": "#trends", 
                "icon": "๐",
                "action": "ุงุณุชูุดู ุงูุงุชุฌุงูุงุช"
            },
            {
                "ุงูุนููุงู": "ุฏููู ุงููุตุทูุญุงุช ุงููุงููููุฉ", 
                "ุงููุตู": "ูุนุฌู ูููุตุทูุญุงุช ูุงูููุงููู ุงููุงููููุฉ", 
                "ุงูููุน": "ูุฑุฌุน", 
                "link": "#glossary", 
                "icon": "๐",
                "action": "ุงุจุญุซ ูู ุงููุตุทูุญุงุช"
            }
        ]
    }
    return data

def smart_recommender(role_label="ุงูุนูุงู", n=None, show_header=True):
    """
    ุนุฑุถ ุงูุชูุตูุงุช ุงูุฐููุฉ ุจุดูู ุฃููู ููุชุฌุงูุจ
    
    Args:
        role_label (str): ูุฆุฉ ุงููุณุชุฎุฏู
        n (int): ุนุฏุฏ ุงูุชูุตูุงุช ุงููุทููุจุฉ
        show_header (bool): ุนุฑุถ ุนููุงู ุงููุณู
    """
    try:
        # ุฌูุจ ุงูุจูุงูุงุช
        recommendations = get_recommendations_data().get(role_label, [])
        
        if not recommendations:
            st.info("๐ฏ ูุง ุชูุฌุฏ ุชูุตูุงุช ูุชุงุญุฉ ุญุงููุงู ููุฐู ุงููุฆุฉ. ุณูุชู ุฅุถุงูุชูุง ูุฑูุจุงู.")
            return

        # ุนุฑุถ ุงูุนููุงู
        if show_header:
            section_header(f"๐ก ุชูุตูุงุช ูุฎุตุตุฉ ูู {role_label}", "๐ก")

        # ุชุญุฏูุฏ ุนุฏุฏ ุงูุชูุตูุงุช
        n = n or MAX_CARDS
        n = min(n, len(recommendations))
        
        # ุชูููู ุนุฏุฏ ุงูุฃุนูุฏุฉ ุญุณุจ ุนุฏุฏ ุงูุชูุตูุงุช
        num_cols = min(3, n)
        cols = st.columns(num_cols)

        # ุฃููุงุท ุงูุฃููุงู ุญุณุจ ููุน ุงูุชูุตูุฉ
        type_styles = {
            "ุญุงุณุจุฉ": "linear-gradient(135deg, #1E3A8A, #2563EB)",
            "ุชูุนูุฉ": "linear-gradient(135deg, #059669, #10B981)",
            "ูุงูููู": "linear-gradient(135deg, #7C3AED, #8B5CF6)",
            "ุชุนูููู": "linear-gradient(135deg, #DC2626, #EF4444)",
            "ุงูุชุซุงู": "linear-gradient(135deg, #D97706, #F59E0B)",
            "ูุฑุฌุน": "linear-gradient(135deg, #7C3AED, #6D28D9)",
            "ูููุฐุฌ": "linear-gradient(135deg, #0F766E, #14B8A6)",
            "ุจุญุซ": "linear-gradient(135deg, #4338CA, #4F46E5)"
        }

        # ุนุฑุถ ุงูุชูุตูุงุช
        for idx, rec in enumerate(recommendations[:n]):
            with cols[idx % num_cols]:
                style = type_styles.get(rec['ุงูููุน'], "linear-gradient(135deg, #6B7280, #9CA3AF)")
                
                st.markdown(
                    f"""
                    <div style="
                        background: {style};
                        border-radius: 20px;
                        padding: 1.5rem;
                        margin: 0.5rem 0;
                        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                        text-align: center;
                        color: {CARD_TEXT_COLOR};
                        transition: all 0.3s ease;
                        border: 1px solid rgba(255,255,255,0.1);
                        height: 100%;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                    ">
                        <div>
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;">{rec['icon']}</div>
                            <h4 style="margin: 0.5rem 0; font-weight: 600;">{rec['ุงูุนููุงู']}</h4>
                            <p style="font-size: 0.9rem; opacity: 0.95; line-height: 1.4; margin: 0.5rem 0;">
                                {rec['ุงููุตู']}
                            </p>
                        </div>
                        <div style="margin-top: 1rem;">
                            <span style="
                                background: rgba(255,255,255,0.2); 
                                padding: 0.3rem 0.8rem; 
                                border-radius: 20px; 
                                font-size: 0.8rem;
                                display: inline-block;
                                margin-bottom: 0.8rem;
                            ">{rec['ุงูููุน']}</span>
                            <br>
                            <a href="{rec['link']}" style="
                                color: {CARD_TEXT_COLOR}; 
                                text-decoration: none;
                                background: rgba(255,255,255,0.3);
                                padding: 0.5rem 1rem;
                                border-radius: 10px;
                                font-weight: 500;
                                display: inline-block;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='rgba(255,255,255,0.4)'" 
                            onmouseout="this.style.background='rgba(255,255,255,0.3)'">
                                {rec['action']} โ
                            </a>
                        </div>
                    </div>
                    """,
                    unsafe_allow_html=True
                )

    except Exception as e:
        st.error(f"โ๏ธ ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุชูุตูุงุช: {str(e)}")
        st.info("๐ ูุฑุฌู ุชุญุฏูุซ ุงูุตูุญุฉ ุฃู ุงููุญุงููุฉ ูุงุญูุงู")

def role_selector():
    """ูุญุฏุฏ ุฏูุฑ ุงููุณุชุฎุฏู ูุน ูุตู ููู ูุฆุฉ"""
    
    st.markdown("### ๐ฅ ุงุฎุชุฑ ูุฆุชู")
    
    roles_info = {
        "ุงูุนูุงู": {
            "icon": "๐ท",
            "desc": "ุงูุนุงูููู ูู ุงููุทุงุนูู ุงูุนุงู ูุงูุฎุงุต",
            "features": ["ุญุณุงุจ ุงููุณุชุญูุงุช", "ุญููู ุงูุนูุงู", "ุชูุฏูู ุงูุดูุงูู"]
        },
        "ุฃุตุญุงุจ ุงูุนูู": {
            "icon": "๐ผ", 
            "desc": "ุฃุตุญุงุจ ุงูููุดุขุช ููุฏูุฑู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ",
            "features": ["ุงูุงูุชุฒุงู ุงููุงูููู", "ุญุณุงุจ ุงูุชูุงููู", "ููุงุฐุฌ ุงูุนููุฏ"]
        },
        "ููุชุดู ุงูุนูู": {
            "icon": "๐",
            "desc": "ููุธูู ุงูุชูุชูุด ูุงูุฌูุงุช ุงูุฑูุงุจูุฉ",
            "features": ["ููุงุฐุฌ ุงูุชูุงุฑูุฑ", "ุฏููู ุงูุฅุฌุฑุงุกุงุช", "ูุงุนุฏุฉ ุงูุชุดุฑูุนุงุช"]
        },
        "ุงูุจุงุญุซูู ูุงููุชุฏุฑุจูู": {
            "icon": "๐",
            "desc": "ุจุงุญุซูู ูุงูููููู ูุทูุงุจ ููุชุฏุฑุจูู",
            "features": ["ุงูุณูุงุจู ุงููุถุงุฆูุฉ", "ุงูุฏุฑุงุณุงุช ุงูุชุญููููุฉ", "ุงููุตุทูุญุงุช ุงููุงููููุฉ"]
        }
    }
    
    cols = st.columns(4)
    selected_role = st.session_state.get("selected_role", "ุงูุนูุงู")
    
    for idx, (role, info) in enumerate(roles_info.items()):
        with cols[idx]:
            is_selected = (role == selected_role)
            bg_color = "linear-gradient(135deg, #1E3A8A, #2563EB)" if is_selected else "linear-gradient(135deg, #F8FAFC, #E2E8F0)"
            text_color = "#FFFFFF" if is_selected else "#1E293B"
            
            if st.button(
                f"""
                <div style="text-align: center; padding: 1.5rem 1rem;">
                    <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">{info['icon']}</div>
                    <h4 style="margin: 0.5rem 0; color: {text_color};">{role}</h4>
                    <p style="font-size: 0.8rem; color: {text_color}; opacity: 0.9; margin: 0;">
                        {info['desc']}
                    </p>
                </div>
                """,
                key=f"role_{idx}",
                use_container_width=True
            ):
                st.session_state.selected_role = role
                st.rerun()
    
    return selected_role

# ุฏุงูุฉ ูุณุงุนุฏุฉ ููุงุณุชุฎุฏุงู ุงูุณุฑูุน
def show_smart_recommendations(role=None):
    """ุนุฑุถ ูุธุงู ุงูุชูุตูุงุช ุงููุงูู"""
    if role is None:
        role = role_selector()
    
    smart_recommender(role)

# ูุซุงู ููุงุณุชุฎุฏุงู
if __name__ == "__main__":
    st.title("๐ฏ ูุธุงู ุงูุชูุตูุงุช ุงูุฐููุฉ")
    show_smart_recommendations()